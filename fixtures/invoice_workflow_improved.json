{
  "name": "Invoice Processing - Improved",
  "description": "Workflow mejorado con detección automática de tipo de PDF",
  "nodes": [
    {
      "id": "start",
      "type": "start",
      "label": "Start"
    },
    {
      "id": "read_email_and_extract_pdf",
      "type": "action",
      "label": "Read Email and Extract PDF",
      "executor": "cached",
      "prompt": "Connect to IMAP server and read the first unread email from mario@bimea.es only. Extract email metadata (From, Subject, Date). If the email has a PDF attachment, extract it and encode to base64. Then mark the email as read. Store in context: email_from (string), email_subject (string), email_date (string), has_pdf (boolean), pdf_filename (string if PDF exists), pdf_data (base64 string if PDF exists). Store only primitive values, never objects.",
      "timeout": 60
    },
    {
      "id": "has_pdf_decision",
      "type": "decision",
      "label": "Has PDF?",
      "executor": "cached",
      "prompt": "Set branch_decision to True if has_pdf is True, False otherwise.",
      "timeout": 10
    },
    {
      "id": "send_rejection_email",
      "type": "action",
      "label": "Send Rejection Email",
      "executor": "cached",
      "prompt": "Send rejection email to email_from explaining that the email doesn't contain a PDF attachment. Ask them to resend with PDF. Use SMTP with TLS.",
      "timeout": 30
    },
    {
      "id": "extract_text_from_pdf",
      "type": "action",
      "label": "Extract Text from PDF",
      "executor": "cached",
      "prompt": "Extract text from PDF using PyMuPDF library (import fitz). The PDF is base64-encoded in context['pdf_data']. Decode it using base64.b64decode(), open with fitz.open() from BytesIO stream, extract text from ALL pages using page.get_text() method, and store the complete text in context['ocr_text']. Also set context['extraction_method_used'] = 'pymupdf'.",
      "timeout": 90
    },
    {
      "id": "find_total_amount",
      "type": "action",
      "label": "Find Total Amount",
      "executor": "cached",
      "prompt": "Find the total invoice amount from ocr_text using regex patterns. Look for Spanish invoice terms like 'total', 'importe total', 'Total sin IVA', etc. Handle European number format (comma as decimal separator like 279,00). Convert to float and store in total_amount. Set to 0.0 if not found.",
      "timeout": 30
    },
    {
      "id": "amount_decision",
      "type": "decision",
      "label": "Amount > €1000?",
      "executor": "cached",
      "prompt": "Set branch_decision to True if total_amount > 1000, False otherwise.",
      "timeout": 10
    },
    {
      "id": "send_high_budget_email",
      "type": "action",
      "label": "Send High Budget Email",
      "executor": "cached",
      "prompt": "Send email to email_from notifying that the invoice amount exceeds €1000 threshold and will require manual review. Use SMTP with TLS.",
      "timeout": 30
    },
    {
      "id": "save_invoice_to_db",
      "type": "action",
      "label": "Save Invoice to Database",
      "executor": "cached",
      "prompt": "Save invoice to PostgreSQL 'invoices' table. Decode PDF from base64 to bytea. Use the extraction_method_used value from context for ocr_method field. Set currency='EUR'. Return the inserted ID.",
      "timeout": 60
    },
    {
      "id": "end",
      "type": "end",
      "label": "End"
    }
  ],
  "edges": [
    {
      "from": "start",
      "to": "read_email_and_extract_pdf"
    },
    {
      "from": "read_email_and_extract_pdf",
      "to": "has_pdf_decision"
    },
    {
      "from": "has_pdf_decision",
      "to": "send_rejection_email",
      "condition": "false"
    },
    {
      "from": "has_pdf_decision",
      "to": "extract_text_from_pdf",
      "condition": "true"
    },
    {
      "from": "send_rejection_email",
      "to": "end"
    },
    {
      "from": "extract_text_from_pdf",
      "to": "find_total_amount"
    },
    {
      "from": "find_total_amount",
      "to": "amount_decision"
    },
    {
      "from": "amount_decision",
      "to": "send_high_budget_email",
      "condition": "true"
    },
    {
      "from": "amount_decision",
      "to": "save_invoice_to_db",
      "condition": "false"
    },
    {
      "from": "send_high_budget_email",
      "to": "end"
    },
    {
      "from": "save_invoice_to_db",
      "to": "end"
    }
  ]
}
